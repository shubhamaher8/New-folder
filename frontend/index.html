<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartStock - The Inventory Management System</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <style>
        /* General Styles */
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        header {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .dashboard-title {
            text-align: center;
            margin-bottom: 30px;
        }

        /* Navigation Styles */
        .main-nav {
            background-color: #333;
            position: fixed;
            width: 250px;
            height: 100%;
            left: 0;
            top: 0;
            padding-top: 60px;
            box-shadow: 3px 0 6px rgba(0,0,0,0.1);
        }
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .nav-item {
            padding: 0;
        }
        .nav-link {
            display: block;
            padding: 15px 20px;
            color: #fff;
            text-decoration: none;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }
        .nav-link:hover, .nav-link.active {
            background-color: #4CAF50;
            border-left-color: #fff;
        }
        .nav-link i {
            margin-right: 10px;
        }

        /* Dashboard Content */
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background-color: white;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .card-icon {
            font-size: 30px;
            margin-bottom: 15px;
            color: #4CAF50;
        }
        .card-title {
            font-size: 18px;
            margin-bottom: 10px;
        }
        .card-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .card-info {
            font-size: 14px;
            color: #777;
        }

        /* Recent Activity styles removed as the section is no longer used */

        /* Shortcut Grid */
        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .shortcut-card {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        .shortcut-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .shortcut-icon {
            margin-bottom: 15px;
            width: 50px;
            height: 50px;
            line-height: 50px;
            background-color: #e8f5e9;
            color: #4CAF50;
            font-size: 20px;
            border-radius: 50%;
            display: inline-block;
        }
        .shortcut-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .shortcut-desc {
            font-size: 13px;
            color: #777;
        }

        /* Charts Section */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-card {
            background-color: white;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .chart-title {
            font-weight: bold;
            font-size: 18px;
        }
        .chart-filters {
            display: flex;
            gap: 10px;
        }
        .chart-filter {
            padding: 5px 10px;
            background-color: #f1f1f1;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
        }
        .chart-filter.active {
            background-color: #4CAF50;
            color: white;
        }
        .chart-container {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #777;
        }

        /* Top Products List Styles */
        .top-products-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        .product-item:last-child {
            border-bottom: none;
        }
        .product-name {
            font-weight: 500;
            color: #333;
        }
        .product-number {
            font-weight: bold;
            color: #000000;
        }
        .product-sales {
            font-weight: bold;
            color: #4CAF50;
        }

        .revenue-summary {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .revenue-item {
            text-align: center;
        }
        
        .revenue-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .revenue-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }

        /* Material Icons */
        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
        }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .main-nav {
                width: 70px;
                padding-top: 70px;
            }
            .nav-link span {
                display: none;
            }
            .nav-link i {
                margin-right: 0;
                font-size: 24px;
            }
            .main-content {
                margin-left: 70px;
            }
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="main-nav">
        <ul class="nav-list">
            <li class="nav-item">
                <a href="index.html" class="nav-link active">
                    <i class="material-icons">dashboard</i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="products.html" class="nav-link">
                    <i class="material-icons">inventory_2</i>
                    <span>Products</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="inventory.html" class="nav-link">
                    <i class="material-icons">storefront</i>
                    <span>Inventory</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="orders.html" class="nav-link">
                    <i class="material-icons">shopping_cart</i>
                    <span>Orders</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="suppliers.html" class="nav-link">
                    <i class="material-icons">local_shipping</i>
                    <span>Suppliers</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="sales.html" class="nav-link">
                    <i class="material-icons">point_of_sale</i>
                    <span>Sales</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="sales-reports.html" class="nav-link">
                    <i class="material-icons">assessment</i>
                    <span>Reports</span>
                </a>
            </li>
        </ul>
    </nav>

    <div class="main-content">
        <div class="dashboard-title">
            <h1>SmartStock Dashboard</h1>
            <p>Welcome to your inventory management system</p>
        </div>

        <div class="dashboard-cards">
            <div class="card">
                <div class="card-icon">
                    <i class="material-icons">inventory_2</i>
                </div>
                <div class="card-title">Total Products</div>
                <div class="card-value" id="total-products">0</div>
                <div class="card-info">Products in your catalog</div>
            </div>

            <div class="card">
                <div class="card-icon">
                    <i class="material-icons">shopping_cart</i>
                </div>
                <div class="card-title">Pending Orders</div>
                <div class="card-value" id="pending-orders">0</div>
                <div class="card-info">Orders awaiting fulfillment</div>
            </div>

            <div class="card">
                <div class="card-icon">
                    <i class="material-icons">attach_money</i>
                </div>
                <div class="card-title">Monthly Sales</div>
                <div class="card-value" id="monthly-sales">$0.00</div>
                <div class="card-info">Revenue this month</div>
            </div>

            <div class="card" onclick="window.location.href='inventory.html?filter=low_stock'" style="cursor: pointer;">
                <div class="card-icon">
                    <i class="material-icons">warning</i>
                </div>
                <div class="card-title">Low Stock Items</div>
                <div class="card-value" id="low-stock">0</div>
                <div class="card-info">Items requiring restocking</div>
            </div>

            <div class="card" onclick="window.location.href='products.html?filter=defective'" style="cursor: pointer;">
                <div class="card-icon" style="color: #f44336;">
                    <i class="material-icons">warning</i>
                </div>
                <div class="card-title">Defective Products</div>
                <div class="card-value" id="defective-products">0</div>
                <div class="card-info">Products marked as defective</div>
            </div>

            <div class="card">
                <div class="card-icon">
                    <i class="material-icons">star</i>
                </div>
                <div class="card-title">Best Selling Product</div>
                <div class="card-value" id="best-selling-product">Item</div>
                <div class="card-info" id="best-selling-info">Best sold this month</div>
            </div>
        </div>

        <div class="shortcuts-grid">
            <div class="shortcut-card" onclick="window.location.href='products.html'">
                <div class="shortcut-icon">
                    <i class="material-icons">add_circle</i>
                </div>
                <div class="shortcut-title">Add Product</div>
                <div class="shortcut-desc">Create a new product entry</div>
            </div>

            <div class="shortcut-card" onclick="window.location.href='orders.html'">
                <div class="shortcut-icon">
                    <i class="material-icons">add_shopping_cart</i>
                </div>
                <div class="shortcut-title">New Order</div>
                <div class="shortcut-desc">Create a purchase order</div>
            </div>

            <div class="shortcut-card" onclick="window.location.href='sales.html'">
                <div class="shortcut-icon">
                    <i class="material-icons">receipt</i>
                </div>
                <div class="shortcut-title">Record Sale</div>
                <div class="shortcut-desc">Add a new sales transaction</div>
            </div>

            <div class="shortcut-card" onclick="window.location.href='sales-reports.html'">
                <div class="shortcut-icon">
                    <i class="material-icons">bar_chart</i>
                </div>
                <div class="shortcut-title">Generate Report</div>
                <div class="shortcut-desc">Create a new sales report</div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Sales Overview</div>
                    <div class="chart-filters">
                    </div>
                </div>
                <div class="revenue-summary">
                    <div class="revenue-item">
                        <div class="revenue-label">Total Revenue</div>
                        <div class="revenue-value" id="period-revenue">$0.00</div>
                    </div>
                    <div class="revenue-item">
                        <div class="revenue-label">Average Quarterly Revenue</div>
                        <div class="revenue-value" id="average-daily-revenue">$0.00</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="sales-chart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Top Selling Products</div>
                    <div class="chart-filters">
                    </div>
                </div>
                <div class="top-products-list" id="top-products-list">
                    <!-- Top products list will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Recent Activity section removed as there is no backend implementation -->
    </div>

    <script>
        // Global variables
        let products = [];
        let orders = [];
        let sales = [];
        let inventory = [];
        let salesChart;
        let currentPeriod = 'quarter';

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Load data for the dashboard
            loadProducts();
            loadOrders();
            loadSales();
            loadInventory();
            setupChartFilters();
        });

        // Function to load products data
        function loadProducts() {
            fetch('http://localhost:3000/api/products')
                .then(response => response.json())
                .then(data => {
                    products = data;
                    updateProductsCount();
                    updateDefectiveCount();
                })
                .catch(error => {
                    console.error('Error loading products:', error);
                    updateProductsCount();
                    updateDefectiveCount();
                });
        }

        // Function to load orders data
        function loadOrders() {
            fetch('http://localhost:3000/api/orders')
                .then(response => response.json())
                .then(data => {
                    orders = data;
                    updatePendingOrdersCount();
                })
                .catch(error => {
                    console.error('Error loading orders:', error);
                    updatePendingOrdersCount();
                });
        }

        // Function to load sales data
        function loadSales() {
            fetch('http://localhost:3000/api/sales')
                .then(response => response.json())
                .then(data => {
                    sales = data;
                    updateMonthlySales();
                    updateSalesChart(currentPeriod);
                     updateBestSellingProduct();
                     updateTopProductsChart();
                })
                .catch(error => {
                    console.error('Error loading sales:', error);
                    updateMonthlySales();
                    updateSalesChart(currentPeriod);
                    updateBestSellingProduct(); 
                    updateTopProductsChart();
                });
        }

        // Function to load inventory data
        function loadInventory() {
            fetch('http://localhost:3000/api/inventory')
                .then(response => response.json())
                .then(data => {
                    inventory = data;
                    updateLowStockCount();
                })
                .catch(error => {
                    console.error('Error loading inventory:', error);
                    updateLowStockCount();
                });
        }

        // Function to update the products count
        function updateProductsCount() {
            document.getElementById('total-products').textContent = products.length;
        }

        // Function to update the pending orders count
        function updatePendingOrdersCount() {
            const pendingOrders = orders.filter(order => order.status === 'Pending').length;
            document.getElementById('pending-orders').textContent = pendingOrders;
        }

        // Function to update the monthly sales figure
        function updateMonthlySales() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            // Filter sales for current month
            const currentMonthSales = sales.filter(sale => {
                const saleDate = new Date(sale.saleDate);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            });
            
            // Calculate total revenue
            const totalRevenue = currentMonthSales.reduce((total, sale) => total + sale.totalRevenue, 0);
            document.getElementById('monthly-sales').textContent = `$${totalRevenue.toFixed(2)}`;
        }

        // Function to update the low stock count
        function updateLowStockCount() {
            // Consider items with quantity 5 or less as low stock
            const lowStockItems = inventory.filter(item => item.stock <= 10).length;
            document.getElementById('low-stock').textContent = lowStockItems;
        }

        // Function to update the defective products count
        function updateDefectiveCount() {
            const defectiveCount = products.filter(product => product.isDefective).length;
            document.getElementById('defective-products').textContent = defectiveCount;
        }

        // Function to update the best selling product card
        function updateBestSellingProduct() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
    
            // Filter sales for current month
            const currentMonthSales = sales.filter(sale => {
                const saleDate = new Date(sale.saleDate);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            });
            
            //best selling item
            const productSales = {};
            currentMonthSales.forEach(sale => {
                let productId, productName;
                if (sale.product && typeof sale.product === 'object') {
                    productId = sale.product._id;
                    productName = sale.product.name;
                } else {
                    productId = sale.productId || sale.product;
                    const prod = products.find(p => p._id === productId);
                    productName = prod ? prod.name : 'Unknown';
                }
                if (!productSales[productId]) {
                    productSales[productId] = {
                        name: productName,
                        quantity: 0
                    };
                }
                productSales[productId].quantity += sale.quantitySold;
            });

            let bestProduct = { name: 'None', quantity: 0 };
            for (const productId in productSales) {
                if (productSales[productId].quantity > bestProduct.quantity) {
                    bestProduct = productSales[productId];
                }
            }

            // Update the card
            document.getElementById('best-selling-product').textContent = bestProduct.name;
            document.getElementById('best-selling-info').textContent = `${bestProduct.quantity} units sold this month`;
        }


        // Function to set up chart filters
        function setupChartFilters() {
            const filterContainers = document.querySelectorAll('.chart-filters');
            
            filterContainers.forEach(container => {
                const filters = container.querySelectorAll('.chart-filter');
                
                filters.forEach(filter => {
                    filter.addEventListener('click', function() {
                        // Remove active class from all filters in this container
                        container.querySelectorAll('.chart-filter').forEach(f => {
                            f.classList.remove('active');
                        });
                        
                        // Add active class to clicked filter
                        this.classList.add('active');
                        
                        // Update appropriate chart based on container
                        if (this.dataset.period) {
                            currentPeriod = this.dataset.period;
                            updateSalesChart(currentPeriod);
                        }
                    });
                });
            });
        }

        // Function to format date for labels
        function formatDate(date, period) {
            switch(period) {
                case 'quarter':
                    const quarter = Math.floor(date.getMonth() / 3) + 1;
                    return `Q${quarter} ${date.getFullYear()}`;
                case 'year':
                    return date.toLocaleDateString('en-US', { month: 'short' });
            }
        }

        // Function to get date ranges for periods
        function getDateRange(period) {
            const now = new Date();
            const start = new Date();
            
            switch(period) {
                case 'quarter':
                    start.setMonth(now.getMonth() - 12); // Show last 12 months (4 quarters)
                    break;
                case 'year':
                    start.setFullYear(now.getFullYear() - 1);
                    break;
            }
            
            return { start, end: now };
        }

        // Function to prepare sales data for the chart
        function prepareSalesData(period) {
            const { start, end } = getDateRange(period);
            const dateLabels = [];
            const salesData = [];
            
            // Create date points
            let current = new Date(start);
            while (current <= end) {
                dateLabels.push(formatDate(current, period));
                
                // Find sales for this date period
                let periodSales = [];
                
                if (period === 'quarter') {
                    // For quarters, aggregate by quarter (3 months)
                    const quarterStart = new Date(current.getFullYear(), Math.floor(current.getMonth() / 3) * 3, 1);
                    const quarterEnd = new Date(current.getFullYear(), Math.floor(current.getMonth() / 3) * 3 + 3, 0);
                    
                    periodSales = sales.filter(sale => {
                        const saleDate = new Date(sale.saleDate);
                        return saleDate >= quarterStart && saleDate <= quarterEnd;
                    });
                } else {
                    // For other periods, use existing logic
                    periodSales = sales.filter(sale => {
                        const saleDate = new Date(sale.saleDate);
                        return period === 'year' 
                            ? saleDate.getFullYear() === current.getFullYear() && 
                              saleDate.getMonth() === current.getMonth()
                            : saleDate.getFullYear() === current.getFullYear() && 
                              saleDate.getMonth() === current.getMonth() && 
                              saleDate.getDate() === current.getDate();
                    });
                }
                
                const totalRevenue = periodSales.reduce((sum, sale) => sum + sale.totalRevenue, 0);
                salesData.push(totalRevenue);
                
                // Increment date based on period
                switch(period) {
                    case 'quarter':
                        current.setMonth(current.getMonth() + 3); // Move to next quarter
                        break;
                    case 'year':
                        current.setMonth(current.getMonth() + 1);
                        break;
                }
            }
            
            return { labels: dateLabels, data: salesData };
        }

        // Function to update the sales chart
        function updateSalesChart(period) {
            const { labels, data } = prepareSalesData(period);
            
            // Calculate total and average revenue
            const totalRevenue = data.reduce((sum, value) => sum + value, 0);
            const avgQuarterlyRevenue = period === 'quarter' ? totalRevenue / 4 : totalRevenue / data.length;
            
            // Update revenue display
            document.getElementById('period-revenue').textContent = '$' + totalRevenue.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            document.getElementById('average-daily-revenue').textContent = '$' + avgQuarterlyRevenue.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            if (salesChart) {
                salesChart.destroy();
            }
            
            const ctx = document.getElementById('sales-chart').getContext('2d');
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sales Revenue',
                        data: data,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Revenue: $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // Also update monthly sales card with current month total
            const currentMonthTotal = data.reduce((sum, value) => sum + value, 0);
            document.getElementById('monthly-sales').textContent = '$' + currentMonthTotal.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Function to update the top products list
        function updateTopProductsChart(isSalesView = true) {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
    
            // Filter sales for current month
            const currentMonthSales = sales.filter(sale => {
                const saleDate = new Date(sale.saleDate);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            });
    
            // Aggregate by product
            const productSales = {};
            const productRevenue = {};
            currentMonthSales.forEach(sale => {
                let productId, productName;
                if (sale.product && typeof sale.product === 'object') {
                    productId = sale.product._id;
                    productName = sale.product.name;
                } else {
                    productId = sale.productId || sale.product;
                    const prod = products.find(p => p._id === productId);
                    productName = prod ? prod.name : 'Unknown';
                }
                
                if (!productSales[productName]) {
                    productSales[productName] = 0;
                    productRevenue[productName] = 0;
                }
                productSales[productName] += sale.quantitySold || 0;
                productRevenue[productName] += sale.totalRevenue || 0;
            });
    
            // Sort and get top 5 products
            const topProducts = Object.entries(productSales)
                .map(([name, sales]) => ({ name, sales, revenue: productRevenue[name] }))
                .sort((a, b) => (isSalesView ? b.sales - a.sales : b.revenue - a.revenue))
                .slice(0, 5);
            
            // Create the list
            const listContainer = document.getElementById('top-products-list');
            listContainer.innerHTML = '';
            
            if (topProducts.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #777; padding: 20px;">No sales data available for this month</p>';
                return;
            }
            
            topProducts.forEach((product, index) => {
                const productItem = document.createElement('div');
                productItem.className = 'product-item';
                productItem.innerHTML = `
                    <div class="product-name"><span class="product-number">${index + 1}.</span> ${product.name}</div>
                    <div class="product-sales">${product.sales} units</div>
                `;
                listContainer.appendChild(productItem);
            });
        }
    </script>
</body>
</html>