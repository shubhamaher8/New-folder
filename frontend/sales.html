<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartStock - Sales</title>
    <style>
        /* General Styles */
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        header {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h2 {
            border-bottom: 2px solid #f2f2f2;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .actions {
            display: flex;
            gap: 10px;
        }
        .btn-danger {
            background-color: #f44336;
        }
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        .btn-info {
            background-color: #2196F3;
        }
        .btn-info:hover {
            background-color: #0b7dda;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        /* Dashboard Styles */
        .dashboard {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        .dashboard-card {
            flex: 1;
            min-width: 200px;
            background-color: white;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .card-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        .card-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .card-trend {
            font-size: 12px;
            margin-top: 5px;
        }
        .trend-up {
            color: #4CAF50;
        }
        .trend-down {
            color: #f44336;
        }

        /* Navigation Styles */
        .nav-links {
            display: flex;
            justify-content: center;
            background-color: #444;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            margin: 0 5px;
            border-radius: 3px;
            transition: background-color 0.3s;
        }
        .nav-links a:hover {
            background-color: #4CAF50;
        }
        .nav-links a.active {
            background-color: #4CAF50;
        }
    </style>
</head>
<body>
    <header>
        <h1>SmartStock</h1>
    </header>
    
    <div class="container">
        <div class="nav-links">
            <a href="index.html">Dashboard</a>
            <a href="products.html">Products</a>
            <a href="inventory.html">Inventory</a>
            <a href="orders.html">Orders</a>
            <a href="suppliers.html">Suppliers</a>
            <a href="sales.html" class="active">Sales</a>
            <a href="sales-reports.html">Reports</a>
        </div>
        
        <h2>Sales Management</h2>
        
        <div class="dashboard">
            <div class="dashboard-card">
                <div class="card-title">Total Sales This Month</div>
                <div class="card-value" id="total-sales">0</div>
                <div class="card-trend" id="sales-trend">+0% from last month</div>
            </div>
            <div class="dashboard-card">
                <div class="card-title">Total Revenue This Month</div>
                <div class="card-value" id="total-revenue">$0.00</div>
                <div class="card-trend" id="revenue-trend">+0% from last month</div>
            </div>
            <div class="dashboard-card">
                <div class="card-title">Best Selling Product</div>
                <div class="card-value" id="best-product">None</div>
                <div class="card-trend" id="product-sales">0 units sold</div>
            </div>
        </div>
        
        <div id="sale-form-container">
            <h3>Record New Sale</h3>
            <form id="sale-form">
                <div class="form-group">
                    <label for="product">Product</label>
                    <select id="product" name="product" required>
                        <option value="">Select a product</option>
                        <!-- Products will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="quantitySold">Quantity Sold</label>
                    <input type="number" id="quantitySold" name="quantitySold" min="1" required>
                </div>
                <div class="form-group">
                    <label for="totalRevenue">Total Revenue</label>
                    <input type="number" id="totalRevenue" name="totalRevenue" step="0.01" min="0" required>
                </div>
                <button type="submit">Record Sale</button>
            </form>
        </div>
        
        <h3>Sales History</h3>
        <table id="sales-table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Quantity Sold</th>
                    <th>Revenue</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="sales-list">
                <!-- Sales will be loaded here -->
            </tbody>
        </table>
    </div>

    <script>
        // Global variables
        let sales = [];
        let products = [];

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Load products for the dropdown
            loadProducts();
            
            // Load sales when page loads
            loadSales();
            
            // Handle form submission
            document.getElementById('sale-form').addEventListener('submit', function(e) {
                e.preventDefault();
                recordSale();
            });

            // Calculate total revenue when product or quantity changes
            document.getElementById('product').addEventListener('change', calculateTotalRevenue);
            document.getElementById('quantitySold').addEventListener('input', calculateTotalRevenue);
        });

        // Function to load products for the dropdown
        function loadProducts() {
            fetch('http://localhost:3000/api/products')
                .then(response => response.json())
                .then(data => {
                    products = data;
                    populateProductDropdown();
                })
                .catch(error => {
                    console.error('Error loading products:', error);
                    // For demo purposes, add some sample products if API is not available
                    products = [
                        { _id: '1', name: 'Sample Product 1', sku: 'ELEC001', price: 19.99 },
                        { _id: '2', name: 'Sample Product 2', sku: 'CLOTH001', price: 29.99 },
                        { _id: '3', name: 'Sample Product 3', sku: 'HOME001', price: 39.99 },
                        { _id: '4', name: 'Sample Product 4', sku: 'ELEC002', price: 49.99 },
                        { _id: '5', name: 'Sample Product 5', sku: 'TOYS001', price: 59.99 }
                    ];
                    populateProductDropdown();
                });
        }

        // Function to populate product dropdown
        function populateProductDropdown() {
            const productSelect = document.getElementById('product');
            productSelect.innerHTML = '<option value="">Select a product</option>';
            
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product._id;
                option.textContent = `${product.name} (${product.sku}) - $${product.price.toFixed(2)}`;
                option.dataset.price = product.price;
                productSelect.appendChild(option);
            });
        }

        // Function to calculate total revenue based on product price and quantity
        function calculateTotalRevenue() {
            const productSelect = document.getElementById('product');
            const quantityInput = document.getElementById('quantitySold');
            const revenueInput = document.getElementById('totalRevenue');
            
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const quantity = parseInt(quantityInput.value) || 0;
            
            if (selectedOption && selectedOption.dataset.price) {
                const price = parseFloat(selectedOption.dataset.price);
                const revenue = price * quantity;
                revenueInput.value = revenue.toFixed(2);
            }
        }

        // Function to load sales from API
        function loadSales() {
            fetch('http://localhost:3000/api/sales')
                .then(response => response.json())
                .then(data => {
                    sales = data;
                    displaySales();
                    updateDashboard();
                })
                .catch(error => {
                    console.error('Error loading sales:', error);
                    // For demo purposes, add some sample sales if API is not available
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    const twoDaysAgo = new Date(today);
                    twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
                    
                    sales = [
                        { 
                            _id: '1', 
                            product: { _id: '1', name: 'Sample Product 1', sku: 'ELEC001' }, 
                            quantitySold: 5, 
                            totalRevenue: 99.95,
                            saleDate: today
                        },
                        { 
                            _id: '2', 
                            product: { _id: '2', name: 'Sample Product 2', sku: 'CLOTH001' }, 
                            quantitySold: 3, 
                            totalRevenue: 89.97,
                            saleDate: yesterday
                        },
                        { 
                            _id: '3', 
                            product: { _id: '1', name: 'Sample Product 1', sku: 'ELEC001' }, 
                            quantitySold: 2, 
                            totalRevenue: 39.98,
                            saleDate: twoDaysAgo
                        }
                    ];
                    displaySales();
                    updateDashboard();
                });
        }

        // Function to display sales in the table
        function displaySales() {
            const salesList = document.getElementById('sales-list');
            salesList.innerHTML = '';
            
            // Sort sales by date (newest first)
            sales.sort((a, b) => new Date(b.saleDate) - new Date(a.saleDate));
            
            sales.forEach(sale => {
                const row = document.createElement('tr');
                const saleDate = new Date(sale.saleDate).toLocaleDateString();
                
                row.innerHTML = `
                    <td>${sale.product.name}</td>
                    <td>${sale.quantitySold}</td>
                    <td>$${sale.totalRevenue.toFixed(2)}</td>
                    <td>${saleDate}</td>
                    <td class="actions">
                        <button class="btn-info" onclick="viewSaleDetails('${sale._id}')">View</button>
                        <button class="btn-danger" onclick="deleteSale('${sale._id}')">Delete</button>
                    </td>
                `;
                salesList.appendChild(row);
            });
        }

        // Function to update the dashboard with sales data
        function updateDashboard() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            // Filter sales for current month
            const currentMonthSales = sales.filter(sale => {
                const saleDate = new Date(sale.saleDate);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            });
            
            // Filter sales for previous month
            const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            const prevMonthSales = sales.filter(sale => {
                const saleDate = new Date(sale.saleDate);
                return saleDate.getMonth() === prevMonth && saleDate.getFullYear() === prevYear;
            });
            
            // Calculate total sales and revenue
            const totalSales = currentMonthSales.reduce((total, sale) => total + sale.quantitySold, 0);
            const totalRevenue = currentMonthSales.reduce((total, sale) => total + sale.totalRevenue, 0);
            
            const prevTotalSales = prevMonthSales.reduce((total, sale) => total + sale.quantitySold, 0);
            const prevTotalRevenue = prevMonthSales.reduce((total, sale) => total + sale.totalRevenue, 0);
            
            // Calculate trends
            const salesTrend = prevTotalSales === 0 ? 100 : ((totalSales - prevTotalSales) / prevTotalSales) * 100;
            const revenueTrend = prevTotalRevenue === 0 ? 100 : ((totalRevenue - prevTotalRevenue) / prevTotalRevenue) * 100;
            
            // Find best selling product
            const productSales = {};
            currentMonthSales.forEach(sale => {
                const productId = sale.product._id;
                if (!productSales[productId]) {
                    productSales[productId] = {
                        name: sale.product.name,
                        quantity: 0
                    };
                }
                productSales[productId].quantity += sale.quantitySold;
            });
            
            let bestProduct = { name: 'None', quantity: 0 };
            for (const productId in productSales) {
                if (productSales[productId].quantity > bestProduct.quantity) {
                    bestProduct = productSales[productId];
                }
            }
            
            // Update the dashboard
            document.getElementById('total-sales').textContent = totalSales;
            document.getElementById('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('best-product').textContent = bestProduct.name;
            document.getElementById('product-sales').textContent = `${bestProduct.quantity} units sold`;
            
            // Update trends
            const salesTrendElement = document.getElementById('sales-trend');
            salesTrendElement.textContent = `${salesTrend >= 0 ? '+' : ''}${salesTrend.toFixed(1)}% from last month`;
            salesTrendElement.className = `card-trend ${salesTrend >= 0 ? 'trend-up' : 'trend-down'}`;
            
            const revenueTrendElement = document.getElementById('revenue-trend');
            revenueTrendElement.textContent = `${revenueTrend >= 0 ? '+' : ''}${revenueTrend.toFixed(1)}% from last month`;
            revenueTrendElement.className = `card-trend ${revenueTrend >= 0 ? 'trend-up' : 'trend-down'}`;
        }

        // Function to record a new sale
        function recordSale() {
            const form = document.getElementById('sale-form');
            const productId = form.product.value;
            const quantitySold = parseInt(form.quantitySold.value);
            const totalRevenue = parseFloat(form.totalRevenue.value);
            
            const sale = {
                product: productId,
                quantitySold: quantitySold,
                totalRevenue: totalRevenue
            };
            
            fetch('http://localhost:3000/api/sales', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(sale)
            })
            .then(response => response.json())
            .then(data => {
                alert('Sale recorded successfully!');
                form.reset();
                loadSales();
            })
            .catch(error => {
                console.error('Error recording sale:', error);
                alert('Failed to record sale. Please try again.');
                // For demo, add to local array and refresh
                const product = products.find(p => p._id === productId);
                
                const newSale = {
                    _id: Date.now().toString(),
                    product: product,
                    quantitySold: quantitySold,
                    totalRevenue: totalRevenue,
                    saleDate: new Date()
                };
                sales.push(newSale);
                displaySales();
                updateDashboard();
                form.reset();
                alert('Sale recorded (demo mode)');
            });
        }

        // Function to view sale details (placeholder)
        function viewSaleDetails(id) {
            const sale = sales.find(s => s._id === id);
            if (sale) {
                const saleDate = new Date(sale.saleDate).toLocaleString();
                const details = `
                    Sale ID: ${sale._id}
                    Product: ${sale.product.name} (${sale.product.sku})
                    Quantity Sold: ${sale.quantitySold}
                    Total Revenue: $${sale.totalRevenue.toFixed(2)}
                    Sale Date: ${saleDate}
                `;
                alert(details);
            }
        }

        // Function to delete a sale
        function deleteSale(id) {
            if (confirm('Are you sure you want to delete this sale record?')) {
                fetch(`http://localhost:3000/api/sales/${id}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        alert('Sale deleted successfully!');
                        loadSales();
                    } else {
                        throw new Error('Failed to delete sale');
                    }
                })
                .catch(error => {
                    console.error('Error deleting sale:', error);
                    // For demo, remove from local array and refresh
                    sales = sales.filter(sale => sale._id !== id);
                    displaySales();
                    updateDashboard();
                    alert('Sale deleted (demo mode)');
                });
            }
        }
    </script>
</body>
</html>