<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartStock - The Inventory Management System</title>
    <link rel="icon" type="image/png" href="/public/favicon.png">
    <style>
        /* General Styles */
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        header {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h2 {
            border-bottom: 2px solid #f2f2f2;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .actions {
            display: flex;
            gap: 10px;
        }
        .btn-danger {
            background-color: #f44336;
        }
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        .btn-info {
            background-color: #2196F3;
        }
        .btn-info:hover {
            background-color: #0b7dda;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        /* View Toggle Styles */
        .view-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .view-toggle button {
            background-color: #f1f1f1;
            color: #333;
            border: 1px solid #ddd;
        }
        .view-toggle button.active {
            background-color: #4CAF50;
            color: white;
        }

        /* Grid View Styles */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .product-card {
            background-color: white;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .product-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .product-sku {
            color: #777;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .product-price {
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 15px;
        }
        .product-description {
            margin-bottom: 15px;
        }
        .product-category {
            background-color: #e1f5fe;
            color: #0288d1;
            padding: 3px 8px;
            border-radius: 12px;
            display: inline-block;
            font-size: 12px;
            margin-bottom: 15px;
        }
        .product-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .product-action {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .product-action:hover {
            background-color: #45a049;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 5px;
            width: 60%;
            max-width: 600px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Navigation Styles */
        .nav-links {
            display: flex;
            justify-content: center;
            background-color: #444;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            margin: 0 5px;
            border-radius: 3px;
            transition: background-color 0.3s;
        }
        .nav-links a:hover {
            background-color: #4CAF50;
        }
        .nav-links a.active {
            background-color: #4CAF50;
        }

        /* View Toggle Styles */
        .view-mode-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }
        .view-mode-toggle button {
            margin: 0 15px;
            background-color: transparent;
            color: #333;
            border: none;
            font-weight: bold;
            padding: 5px 10px;
            cursor: pointer;
        }
        .view-mode-toggle button.active {
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
        }
        .view-mode-toggle button:hover {
            color: #4CAF50;
            background-color: transparent;
        }

        /* Enhanced Rating Styles */
        .rating-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .star-rating {
            display: inline-flex;
            gap: 5px;
            margin: 10px 0;
        }

        .star {
            color: #ddd;
            font-size: 28px;
            cursor: pointer;
            transition: color 0.2s ease;
            -webkit-text-stroke: 1px #ffa41c;
        }

        .star.filled {
            color: #ffa41c;
        }

        .star:hover {
            color: #ffd700;
        }

        .average-rating {
            font-size: 20px;
            margin: 15px 0;
            color: #333;
            font-weight: bold;
        }

        .rating-form {
            margin-top: 25px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .rating-form h4 {
            color: #333;
            margin-bottom: 15px;
        }

        .rating-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin: 15px 0;
            resize: vertical;
        }

        .rating-form button {
            background-color: #4CAF50;
            padding: 12px 25px;
            font-size: 16px;
            margin-top: 10px;
        }

        .rating-list {
            margin-top: 30px;
        }

        .rating-list h4 {
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
        }

        .rating-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 15px;
            background: #fff;
        }

        .rating-comment {
            margin: 10px 0;
            color: #555;
            font-size: 14px;
            line-height: 1.5;
        }

        .rating-date {
            color: #888;
            font-size: 12px;
            margin-top: 5px;
        }

        .product-rating-summary {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }

        .rating-stats {
            font-size: 16px;
            color: #666;
        }

        .product-rating-summary {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .rating-stats h3 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .star-rating.large-stars .star {
            font-size: 32px;
        }

        .rating-numbers {
            font-size: 24px;
            color: #333;
            margin: 10px 0;
        }

        .total-ratings {
            color: #666;
            font-size: 14px;
        }

        #initial-rating-input {
            margin: 10px 0;
        }

        #initial-rating-comment {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }

        /* Defective Product Styles */
        .status-section {
            margin: 20px 0;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-section h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .defective-toggle {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .defective-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
        }

        .defective-toggle label {
            margin: 0;
            font-size: 15px;
            color: #444;
            cursor: pointer;
        }

        .defective-notes {
            margin-top: 15px;
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            min-height: 80px;
            background-color: #fff;
            transition: border-color 0.3s ease;
        }

        .defective-notes:focus {
            border-color: #4CAF50;
            outline: none;
        }

        .defective-badge {
            background-color: #ff4444;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
        }

        .defective-badge i {
            font-size: 16px;
        }

        .product-card.defective {
            border: 2px solid #ff4444;
            position: relative;
        }

        tr.defective {
            background-color: #fff8f8;
        }

        tr.defective:hover {
            background-color: #fff0f0;
        }

        .defective-status-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 15px;
            transition: background-color 0.3s ease;
        }

        .defective-status-btn:hover {
            background-color: #45a049;
        }

        .defective-status-btn.disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .form-group.status-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .status-group .group-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            display: block;
        }
    </style>
</head>
<body>
    <header>
        <h1>SmartStock</h1>
    </header>
    
    <div class="container">
        <div class="nav-links">
            <a href="index.html">Dashboard</a>
            <a href="products.html" class="active">Products</a>
            <a href="inventory.html">Inventory</a>
            <a href="orders.html">Orders</a>
            <a href="suppliers.html">Suppliers</a>
            <a href="sales.html">Sales</a>
            <a href="sales-reports.html">Reports</a>
        </div>
        
        <h2>Product Management</h2>
        
        <div class="view-mode-toggle">
            <button id="table-view-btn" class="active">Table View</button>
            <button id="grid-view-btn">Grid View</button>
        </div>
        
        <div id="product-form-container">
            <h3>Add New Product</h3>
            <form id="product-form">
                <div class="form-group">
                    <label for="name">Product Name</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="price">Price</label>
                    <input type="number" id="price" name="price" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category" name="category">
                        <option value="">Select a category</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Home & Kitchen">Home & Kitchen</option>
                        <option value="Beauty">Beauty</option>
                        <option value="Toys">Toys</option>
                        <option value="Sports">Sports</option>
                        <option value="Books">Books</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sku">SKU</label>
                    <input type="text" id="sku" name="sku" required>
                </div>
                <div class="form-group status-group">
                    <span class="group-title">Product Status</span>
                    <div class="defective-toggle">
                        <input type="checkbox" id="isDefective" name="isDefective">
                        <label for="isDefective">Mark as Defective</label>
                    </div>
                    <textarea id="defectiveNotes" name="defectiveNotes" 
                        class="defective-notes" 
                        placeholder="Please describe the defect in detail..."
                        style="display: none;"></textarea>
                </div>
                <div class="form-group">
                    <label for="initialRating">Initial Rating</label>
                    <div class="star-rating" id="initial-rating-input">
                        <span class="star" data-rating="1">★</span>
                        <span class="star" data-rating="2">★</span>
                        <span class="star" data-rating="3">★</span>
                        <span class="star" data-rating="4">★</span>
                        <span class="star" data-rating="5">★</span>
                    </div>
                    <textarea id="initial-rating-comment" placeholder="Add an initial rating comment (optional)" rows="2"></textarea>
                </div>
                <button type="submit">Add Product</button>
            </form>
        </div>
        
        <h3>Products List</h3>
        <div id="table-view">
            <table id="products-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>SKU</th>
                        <th>Price</th>
                        <th>Category</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="products-list">
                    <!-- Products will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <div id="grid-view" style="display: none;">
            <div class="product-grid" id="products-grid">
                <!-- Products will be loaded here in grid format -->
            </div>
        </div>
    </div>

    <!-- View Product Details Modal -->
    <div id="productDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>Product Details</h3>
            <div id="product-details-content">
                <!-- Product details will be displayed here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let products = [];
        let currentProductId = null;
        let lastActiveView = 'table-view';

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Load products when page loads
            loadProducts();
            
            // Handle form submission
            document.getElementById('product-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addProduct();
            });
            
            // Add event listeners for view toggle buttons
            document.getElementById('table-view-btn').addEventListener('click', function() {
                document.getElementById('table-view').style.display = 'block';
                document.getElementById('grid-view').style.display = 'none';
                this.classList.add('active');
                document.getElementById('grid-view-btn').classList.remove('active');
            });
            
            document.getElementById('grid-view-btn').addEventListener('click', function() {
                document.getElementById('grid-view').style.display = 'block';
                document.getElementById('table-view').style.display = 'none';
                this.classList.add('active');
                document.getElementById('table-view-btn').classList.remove('active');
            });

            // Check if URL has a product ID parameter
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            
            if (productId) {
                loadProductDetails(productId);
                switchView('detail-view');
            }

            // Add event listener for initial rating stars
            const initialRatingStars = document.querySelectorAll('#initial-rating-input .star');
            initialRatingStars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    initialRatingStars.forEach(s => {
                        s.classList.toggle('filled', parseInt(s.dataset.rating) <= rating);
                    });
                });
            });

            // Add event listener for defective checkbox in the form
            document.getElementById('isDefective').addEventListener('change', function() {
                const notesField = document.getElementById('defectiveNotes');
                notesField.style.display = this.checked ? 'block' : 'none';
            });
        });

        // View switching function
        function switchView(viewId) {
            // Hide all views
            document.getElementById('table-view').classList.remove('active');
            document.getElementById('grid-view').classList.remove('active');
            document.getElementById('detail-view').classList.remove('active');
            
            // Remove active class from all buttons
            document.getElementById('table-view-btn').classList.remove('active');
            document.getElementById('grid-view-btn').classList.remove('active');
            
            // Show selected view
            document.getElementById(viewId).classList.add('active');
            
            // Set active button
            if (viewId !== 'detail-view') {
                document.getElementById(viewId + '-btn').classList.add('active');
                lastActiveView = viewId;
            }

            // Update URL if showing detail view with a product ID
            if (viewId === 'detail-view' && currentProductId) {
                history.pushState({ id: currentProductId }, '', `?id=${currentProductId}`);
            } else if (viewId !== 'detail-view') {
                history.pushState({}, '', window.location.pathname);
            }
        }

        // Back button function
        function backToLastView() {
            switchView(lastActiveView);
        }

        // Function to load products from API
        function loadProducts() {
            fetch('http://localhost:3000/api/products')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    products = data;
                    displayProducts();
                })
                .catch(error => {
                    console.error('Error loading products:', error);
                    displayProducts();
                });
        }

        // Function to display products in all views
        function displayProducts() {
            displayProductsTable();
            displayProductsGrid();
        }

        // Function to display products in the table
        function displayProductsTable() {
            const productsList = document.getElementById('products-list');
            productsList.innerHTML = '';
            
            products.forEach(product => {
                const row = document.createElement('tr');
                if (product.isDefective) {
                    row.classList.add('defective');
                }
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center;">
                            <a href="javascript:void(0)" onclick="viewProductDetails('${product._id}')">
                                ${product.name}
                            </a>
                            ${product.isDefective ? '<span class="defective-badge"><i class="material-icons">warning</i>Defective</span>' : ''}
                        </div>
                    </td>
                    <td>${product.sku}</td>
                    <td>$${product.price.toFixed(2)}</td>
                    <td>${product.category || '-'}</td>
                    <td class="actions">
                        <button class="btn-info" onclick="viewProductDetails('${product._id}')">View Details</button>
                        <button class="btn-info" onclick="editProduct('${product._id}')">Edit</button>
                        <button class="btn-danger" onclick="deleteProduct('${product._id}')">Delete</button>
                    </td>
                `;
                productsList.appendChild(row);
            });
        }

        // Function to display products in the grid
        function displayProductsGrid() {
            const productsGrid = document.getElementById('products-grid');
            productsGrid.innerHTML = '';
            
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = `product-card ${product.isDefective ? 'defective' : ''}`;
                card.innerHTML = `
                    <div class="product-name">
                        ${product.name}
                        ${product.isDefective ? '<span class="defective-badge"><i class="material-icons">warning</i>Defective</span>' : ''}
                    </div>
                    <div class="product-price">$${product.price.toFixed(2)}</div>
                    <div class="product-category">${product.category || 'Uncategorized'}</div>
                    <div class="product-sku">SKU: ${product.sku}</div>
                    ${product.isDefective ? `<div class="defective-notes">Defect: ${product.defectiveNotes || 'No details provided'}</div>` : ''}
                    <div class="product-actions">
                        <button class="product-action" onclick="viewProductDetails('${product._id}')">View Details</button>
                        <button class="btn-info" onclick="editProduct('${product._id}')">Edit</button>
                        <button class="btn-danger" onclick="deleteProduct('${product._id}')">Delete</button>
                    </div>
                `;
                productsGrid.appendChild(card);
            });
        }

        // Function to view product details
        function viewProductDetails(productId) {
            loadProductDetails(productId);
            // Show the modal instead of switching view
            document.getElementById('productDetailsModal').style.display = 'block';
        }
        
        // Function to close the modal
        function closeModal() {
            document.getElementById('productDetailsModal').style.display = 'none';
        }

        // Function to load product details
        function loadProductDetails(productId) {
            currentProductId = productId;
            const product = products.find(p => p._id === productId);
            
            if (product) {
                displayProductDetails(product);
            } else {
                fetch(`http://localhost:3000/api/products/${productId}`)
                    .then(response => response.json())
                    .then(product => {
                        displayProductDetails(product);
                    })
                    .catch(error => {
                        console.error('Error loading product details:', error);
                        displayProductDetails(sampleProduct);
                    });
            }
        }

        // Function to display product details
        function displayProductDetails(product) {
            const detailsContainer = document.getElementById('product-details-content');
            const avgRating = product.averageRating || 0;
            const totalRatings = product.totalRatings || 0;
            
            const starDisplay = Array(5).fill('').map((_, i) => 
                `<span class="star ${i < Math.round(avgRating) ? 'filled' : ''}" data-rating="${i + 1}">★</span>`
            ).join('');

            detailsContainer.innerHTML = `
                <div class="product-rating-summary">
                    <div class="rating-stats">
                        <h3>Product Rating</h3>
                        <div class="average-rating">
                            <div class="star-rating large-stars">${starDisplay}</div>
                            <div class="rating-numbers">${avgRating.toFixed(1)} out of 5</div>
                            <div class="total-ratings">${totalRatings} ${totalRatings === 1 ? 'rating' : 'ratings'}</div>
                        </div>
                    </div>
                </div>

                <div class="product-details">
                    <h3>
                        ${product.name}
                        ${product.isDefective ? '<span class="defective-badge"><i class="material-icons">warning</i>Defective</span>' : ''}
                    </h3>
                    
                    <div class="detail-row">
                        <div class="detail-label">Description:</div>
                        <div class="detail-value">${product.description || 'No description available'}</div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-label">Price:</div>
                        <div class="detail-value">$${product.price.toFixed(2)}</div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-label">Category:</div>
                        <div class="detail-value">${product.category || 'Uncategorized'}</div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-label">SKU:</div>
                        <div class="detail-value">${product.sku}</div>
                    </div>

                    <div class="status-section">
                        <h4>Product Status</h4>
                        <div class="defective-toggle">
                            <input type="checkbox" id="detailsIsDefective" 
                                   ${product.isDefective ? 'checked' : ''}>
                            <label for="detailsIsDefective">Mark as Defective</label>
                        </div>
                        <textarea id="detailsDefectiveNotes" 
                            class="defective-notes" 
                            placeholder="Please describe the defect in detail..."
                            style="display: ${product.isDefective ? 'block' : 'none'}"
                            >${product.defectiveNotes || ''}</textarea>
                        <button onclick="updateDefectiveStatus('${product._id}')" 
                            class="defective-status-btn">
                            Update Status
                        </button>
                    </div>

                    <!-- Rating Form -->
                    <div class="rating-form">
                        <h4>Rate this Product</h4>
                        <div class="star-rating" id="rating-input">
                            <span class="star" data-rating="1">★</span>
                            <span class="star" data-rating="2">★</span>
                            <span class="star" data-rating="3">★</span>
                            <span class="star" data-rating="4">★</span>
                            <span class="star" data-rating="5">★</span>
                        </div>
                        <textarea id="rating-comment" placeholder="Add a comment (optional)" rows="3"></textarea>
                        <button onclick="submitRating('${product._id}')">Submit Rating</button>
                    </div>

                    <!-- Ratings List -->
                    <div class="rating-list">
                        <h4>Recent Ratings</h4>
                        <div id="ratings-container">
                            ${renderRatings(product.ratings || [])}
                        </div>
                    </div>
                </div>
            `;

            // Add event listeners
            document.getElementById('detailsIsDefective').addEventListener('change', function() {
                const notesField = document.getElementById('detailsDefectiveNotes');
                notesField.style.display = this.checked ? 'block' : 'none';
            });

            // Add event listeners for rating stars
            const ratingStars = document.querySelectorAll('#rating-input .star');
            ratingStars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    ratingStars.forEach(s => {
                        s.classList.toggle('filled', parseInt(s.dataset.rating) <= rating);
                    });
                });
            });
        }

        // Function to render ratings
        function renderRatings(ratings) {
            if (!ratings.length) return '<p>No ratings yet</p>';
            
            return ratings.slice(0, 5).map(rating => `
                <div class="rating-item">
                    <div class="star-rating">
                        ${Array(5).fill('').map((_, i) => 
                            `<span class="star ${i < rating.rating ? 'filled' : ''}">★</span>`
                        ).join('')}
                    </div>
                    ${rating.comment ? `<div class="rating-comment">${rating.comment}</div>` : ''}
                    <div class="rating-date">${new Date(rating.createdAt).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        // Function to submit a rating
        function submitRating(productId) {
            const ratingValue = document.querySelectorAll('#rating-input .star.filled').length;
            const comment = document.getElementById('rating-comment').value;

            if (!ratingValue) {
                alert('Please select a rating');
                return;
            }

            fetch(`http://localhost:3000/api/products/${productId}/ratings`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    rating: ratingValue,
                    comment: comment
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(updatedProduct => {
                // Update the product in our local array
                const index = products.findIndex(p => p._id === productId);
                if (index !== -1) {
                    products[index] = updatedProduct;
                }
                
                // Clear the form
                document.getElementById('rating-comment').value = '';
                document.querySelectorAll('#rating-input .star').forEach(star => {
                    star.classList.remove('filled');
                });
                
                // Refresh the product details display
                displayProductDetails(updatedProduct);
                alert('Rating submitted successfully!');
            })
            .catch(error => {
                console.error('Error submitting rating:', error);
                alert('Failed to submit rating. Please try again.');
            });
        }

        // Function to add a new product
        function addProduct() {
            const form = document.getElementById('product-form');
            const initialRating = document.querySelectorAll('#initial-rating-input .star.filled').length;
            const initialComment = document.getElementById('initial-rating-comment').value;
            const isDefective = form.isDefective.checked;
            const defectiveNotes = form.defectiveNotes.value;
            
            const product = {
                name: form.name.value,
                description: form.description.value,
                price: parseFloat(form.price.value),
                category: form.category.value,
                sku: form.sku.value,
                isDefective,
                defectiveNotes,
                ratings: initialRating ? [{
                    rating: initialRating,
                    comment: initialComment,
                    createdAt: new Date()
                }] : [],
            };
            
            fetch('http://localhost:3000/api/products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(product)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                alert('Product added successfully!');
                form.reset();
                document.querySelectorAll('#initial-rating-input .star').forEach(star => {
                    star.classList.remove('filled');
                });
                document.getElementById('initial-rating-comment').value = '';
                document.getElementById('defectiveNotes').style.display = 'none';
                loadProducts(); // Reload the products list
            })
            .catch(error => {
                console.error('Error adding product:', error);
                alert('Failed to add product. Please try again.');
            });
        }

        // Function to edit a product
        function editProduct(id) {
            const product = products.find(p => p._id === id);
            if (!product) {
                alert('Product not found!');
                return;
            }
            
            // Fill the form with product data
            const form = document.getElementById('product-form');
            form.name.value = product.name;
            form.description.value = product.description || '';
            form.price.value = product.price;
            form.category.value = product.category || '';
            form.sku.value = product.sku;
            form.isDefective.checked = product.isDefective || false;
            form.defectiveNotes.value = product.defectiveNotes || '';
            document.getElementById('defectiveNotes').style.display = product.isDefective ? 'block' : 'none';
            
            // Change the form submit button text
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Update Product';
            
            // Scroll to the form
            form.scrollIntoView({ behavior: 'smooth' });
            
            // Update the form submission handler
            form.onsubmit = function(e) {
                e.preventDefault();
                
                const updatedProduct = {
                    name: form.name.value,
                    description: form.description.value,
                    price: parseFloat(form.price.value),
                    category: form.category.value,
                    sku: form.sku.value,
                    isDefective: form.isDefective.checked,
                    defectiveNotes: form.defectiveNotes.value
                };
                
                fetch(`http://localhost:3000/api/products/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedProduct)
                })
                .then(response => response.json())
                .then(data => {
                    alert('Product updated successfully!');
                    // Reset form and handler
                    form.reset();
                    submitBtn.textContent = 'Add Product';
                    form.onsubmit = function(e) {
                        e.preventDefault();
                        addProduct();
                    };
                    loadProducts();
                })
                .catch(error => {
                    console.error('Error updating product:', error);
                    // For demo, update the product in our local array
                    const index = products.findIndex(p => p._id === id);
                    if (index !== -1) {
                        products[index] = { ...products[index], ...updatedProduct };
                        displayProducts();
                        // Reset form and handler
                        form.reset();
                        submitBtn.textContent = 'Add Product';
                        form.onsubmit = function(e) {
                            e.preventDefault();
                            addProduct();
                        };
                        alert('Product updated (demo mode)');
                    }
                });
            };
        }

        // Function to delete a product
        function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                fetch(`http://localhost:3000/api/products/${id}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        alert('Product deleted successfully!');
                        loadProducts();
                    } else {
                        throw new Error('Failed to delete product');
                    }
                })
                .catch(error => {
                    console.error('Error deleting product:', error);
                    // For demo, remove from local array and refresh
                    products = products.filter(product => product._id !== id);
                    displayProducts();
                    alert('Product deleted (demo mode)');
                });
            }
        }

        // Function to update defective status
        function updateDefectiveStatus(productId) {
            const isDefective = document.getElementById('detailsIsDefective').checked;
            const defectiveNotes = document.getElementById('detailsDefectiveNotes').value;

            fetch(`http://localhost:3000/api/products/${productId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    isDefective,
                    defectiveNotes
                })
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(updatedProduct => {
                // Update the product in our local array
                const index = products.findIndex(p => p._id === productId);
                if (index !== -1) {
                    products[index] = updatedProduct;
                }
                displayProducts();
                alert('Product status updated successfully!');
            })
            .catch(error => {
                console.error('Error updating product status:', error);
                alert('Failed to update product status. Please try again.');
            });
        }

        // Handle browser back button
        window.addEventListener('popstate', function(event) {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            
            if (productId) {
                loadProductDetails(productId);
                switchView('detail-view');
            } else {
                switchView(lastActiveView);
            }
        });
    </script>
</body>
</html>